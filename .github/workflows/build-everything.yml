name: Build Everything (Just Works)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: build-everything-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linux_engine:
    name: Linux (Go engine + analysis)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Go vet + tests (non-fatal)
        working-directory: apps/server-go
        run: |
          set -eux
          go mod download
          go vet ./... || true
          go test ./... || true

      - name: Build Go server
        working-directory: apps/server-go
        run: |
          set -eux
          mkdir -p ../../dist/linux
          go build -trimpath -ldflags "-s -w" -o ../../dist/linux/stressless-server ./cmd/server

      - name: Upload Go artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stressless-go-linux
          path: dist/linux/stressless-server

  windows_portable:
    name: Windows (WPF portable)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # ---- AUTO-FIX: WPF duplicate Page items (NETSDK1022) ----
      - name: Patch csproj (auto-fix NETSDK1022 duplicate Page items)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          $csproj = "apps/windows-wpf/Stressless.Wpf/Stressless.Wpf.csproj"
          if (Test-Path $csproj) {
            $raw = Get-Content $csproj -Raw

            # Remove explicit <Page Include="Theme.xaml" .../> lines if present (SDK includes XAML implicitly).
            $patched = $raw -replace '(?im)^\s*<Page\s+Include="Theme\.xaml"\s*/>\s*\r?\n',''
            $patched = $patched -replace '(?im)^\s*<Page\s+Include="Theme\.xaml"\s*>\s*</Page>\s*\r?\n',''

            if ($patched -ne $raw) {
              Write-Host "Patched: removed explicit Page Include for Theme.xaml"
              Set-Content -Path $csproj -Value $patched -Encoding UTF8
            } else {
              Write-Host "No csproj patch needed"
            }
          } else {
            Write-Host "csproj not found (skipping patch)"
          }

      # ---- BUILD ----
      - name: Build portable
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          if (-not (Test-Path ".\scripts\build_windows_portable.ps1")) {
            throw "Missing scripts/build_windows_portable.ps1 (repo structure unexpected)."
          }

          powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\build_windows_portable.ps1

      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stressless-portable-windows
          path: dist/portable/stressless/**

  android_apk:
    name: Android (APK)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect Android project directory
        id: detect
        shell: bash
        run: |
          set -e
          if [ -d "apps/android" ]; then
            echo "dir=apps/android" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          elif [ -d "android" ]; then
            echo "dir=android" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "dir=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup JDK
        if: ${{ steps.detect.outputs.found == 'true' }}
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "gradle"

      - name: Setup Android SDK
        if: ${{ steps.detect.outputs.found == 'true' }}
        uses: android-actions/setup-android@v3

      - name: Build APK (debug)
        if: ${{ steps.detect.outputs.found == 'true' }}
        shell: bash
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          set -eux
          chmod +x ./gradlew
          ./gradlew assembleDebug

      # If Android project is missing, produce a clear artifact instead of failing CI.
      - name: Create "missing Android project" artifact
        if: ${{ steps.detect.outputs.found != 'true' }}
        shell: bash
        run: |
          set -eux
          mkdir -p dist/android
          cat > dist/android/ANDROID_MISSING.txt <<'EOF'
          Android project not found.
          Expected one of:
            - apps/android/
            - android/

          CI passed by design (no hard fail), but no APK was built.
          Add your Android project and re-run.
          EOF

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: Stressless-android
          path: |
            dist/android/**
            ${{ steps.detect.outputs.dir }}/app/build/outputs/apk/**/*.apk
